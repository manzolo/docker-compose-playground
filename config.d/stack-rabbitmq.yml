# Group metadata
group:
  name: "RabbitMQ-Stack"
  description: "RabbitMQ message broker with Management web interface"
  category: message_queue
  containers:
    - rabbitmq-server
    - rabbitmq-management

# Container configurations
images:
  rabbitmq-server:
    category: message_queue
    description: RabbitMQ 3.13 Message Broker
    image: rabbitmq:3.13-alpine
    keep_alive_cmd: rabbitmq-server
    shell: /bin/sh
    environment:
      RABBITMQ_DEFAULT_USER: "admin"
      RABBITMQ_DEFAULT_PASS: "admin123"
      RABBITMQ_DEFAULT_VHOST: "/"
      RABBITMQ_ERLANG_COOKIE: "playground-secret-cookie-12345"
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    volumes:
      - type: named
        name: rabbitmq_data
        path: /var/lib/rabbitmq
      - type: named
        name: rabbitmq_logs
        path: /var/log/rabbitmq
    scripts:
      post_start:
        inline: |
          #!/bin/sh

          echo "Initializing RabbitMQ..."

          CONTAINER="${CONTAINER_NAME}"

          # Wait a bit for RabbitMQ to start
          sleep 10

          # Enable management plugin (non-critical)
          echo "Enabling management plugin..."
          docker exec "${CONTAINER}" rabbitmq-plugins enable rabbitmq_management 2>/dev/null || true

          sleep 3

          # Create app user (non-critical)
          echo "Creating app user..."
          docker exec "${CONTAINER}" rabbitmqctl add_user app_user app_pass123 2>/dev/null || true
          docker exec "${CONTAINER}" rabbitmqctl set_permissions -p / app_user ".*" ".*" ".*" 2>/dev/null || true

          echo "âœ“ RabbitMQ initialization completed"
          exit 0

      pre_stop:
        inline: |
          #!/bin/sh
          echo "Stopping RabbitMQ gracefully..."
          docker exec "${CONTAINER_NAME}" rabbitmqctl stop_app 2>/dev/null || true
          sleep 2

    motd: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘              RabbitMQ 3.13 Message Broker                    â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ğŸ”  AMQP Connection:
        Host: rabbitmq-server
        Port: 5672
        User: admin / app_user
        Password: admin123 / app_pass123

      ğŸŒ  Management UI: http://localhost:15672
        User: admin
        Password: admin123

      ğŸ“Š  Quick Commands:
        rabbitmqctl status
        rabbitmqctl list_exchanges
        rabbitmqctl list_queues
        rabbitmqctl list_bindings
        rabbitmqctl list_connections

      ğŸ¯  Learning - Exchange Types:

      ğŸ”¹ DIRECT Exchange:
        â€¢ Routes by routing key
        â€¢ One message â†’ one queue (if routing key matches)
        â€¢ Use case: Task distribution (high/medium/low priority)

      ğŸ”¹ TOPIC Exchange:
        â€¢ Routes by pattern matching
        â€¢ Routing keys: "user.created", "user.deleted", "order.*"
        â€¢ Use case: Event-driven systems

      ğŸ”¹ FANOUT Exchange:
        â€¢ Broadcast to ALL bound queues
        â€¢ Ignores routing key
        â€¢ Use case: Notifications, live updates

      ğŸ“  Publishing a Message via Management UI (easier):
        Go to http://localhost:15672 â†’ Exchanges â†’ playground.direct â†’ Publish message
        
        # Or use a client library (Python, Node.js, Java, Go, etc)

  rabbitmq-management:
    category: message_queue
    description: RabbitMQ Management Dashboard (alias container)
    image: rabbitmq:3.13-alpine
    keep_alive_cmd: sleep infinity
    shell: /bin/sh
    depends_on:
      - rabbitmq-server
    ports: []
    motd: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘         RabbitMQ Management - Info Container                â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ğŸŒ  Dashboard: http://localhost:15672
        User: admin
        Password: admin123

      ğŸ” This is a helper container with CLI tools
      Connect to rabbitmq-server for AMQP connections
