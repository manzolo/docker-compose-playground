# Group metadata
group:
  name: "Joomla-Stack"
  description: "Joomla CMS with MySQL 8, phpMyAdmin and automatic backup/restore system for persistence between restarts"
  category: programming
  containers:
    - mysql-joomla-stack
    - web-joomla-stack
    - phpmyadmin-joomla-stack

# Container configurations
images:
  mysql-joomla-stack:
    category: database
    description: MySQL 8 Database Server for Joomla Stack
    image: mysql:8
    keep_alive_cmd: mysqld
    shell: /bin/bash
    ports:
      - "3311:3306"
    environment:
      MYSQL_DATABASE: joomla_db
      MYSQL_ROOT_PASSWORD: joomla
      MYSQL_USER: joomla
      MYSQL_PASSWORD: joomla
    scripts:
      post_start:
        inline: |
          #!/bin/bash
          echo "Initializing MySQL for Joomla..."

          # Wait for MySQL to be ready with longer timeout
          MAX_WAIT=90
          COUNT=0
          echo -n "Waiting for MySQL to start"
          while [ $COUNT -lt $MAX_WAIT ]; do
            if docker exec "${CONTAINER_NAME}" mysqladmin ping -u root -pjoomla --silent 2>/dev/null; then
              echo ""
              echo "âœ“ MySQL is ready!"
              break
            fi
            echo -n "."
            sleep 3
            COUNT=$((COUNT + 3))
            if [ $COUNT -ge $MAX_WAIT ]; then
              echo ""
              echo "âœ— MySQL failed to start within $MAX_WAIT seconds"
              exit 1
            fi
          done

          # Additional safety wait
          sleep 5

          # Create Joomla database and user (idempotent)
          echo "Setting up Joomla database..."
          docker exec "${CONTAINER_NAME}" mysql -u root -pjoomla -e "
          CREATE DATABASE IF NOT EXISTS joomla_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
          CREATE USER IF NOT EXISTS 'joomla'@'%' IDENTIFIED BY 'joomla';
          GRANT ALL PRIVILEGES ON joomla_db.* TO 'joomla'@'%';
          FLUSH PRIVILEGES;
          " 2>/dev/null

          # Wait a bit more before attempting restore
          sleep 3

          # Restore from the latest backup if available
          BACKUP_DIR="${SHARED_DIR}/data/backups/${CONTAINER_NAME#playground-}"
          echo "Checking for database backups in ${BACKUP_DIR}..."
          if [ -d "${BACKUP_DIR}" ] && [ "$(ls -A "${BACKUP_DIR}"/*.sql.gz 2>/dev/null)" ]; then
            # Find the latest database backup
            LATEST_DB_BACKUP=$(ls -t "${BACKUP_DIR}"/joomla_db_*.sql.gz 2>/dev/null | head -1)
            if [ -n "${LATEST_DB_BACKUP}" ]; then
              echo "âœ“ Found database backup: ${LATEST_DB_BACKUP}. Starting restore..."

              # Decompress the backup temporarily
              TEMP_SQL="${SHARED_DIR}/temp_restore.sql"
              gunzip -c "${LATEST_DB_BACKUP}" > "${TEMP_SQL}" 2>/dev/null

              # Verify the SQL file is not empty
              if [ -s "${TEMP_SQL}" ]; then
                echo "Importing backup into joomla_db database..."
                docker exec -i "${CONTAINER_NAME}" mysql -u root -pjoomla joomla_db < "${TEMP_SQL}" 2>/dev/null
                if [ $? -eq 0 ]; then
                  echo "âœ“ Database restore completed successfully from ${LATEST_DB_BACKUP}"
                else
                  echo "âœ— Database restore failed for ${LATEST_DB_BACKUP}"
                fi
              else
                echo "âœ— Database backup file ${LATEST_DB_BACKUP} is empty or invalid"
              fi

              # Clean up temporary file
              rm -f "${TEMP_SQL}"
            else
              echo "âœ— No valid database backup found"
            fi
          else
            echo "âœ— No database backups found in ${BACKUP_DIR}"
          fi

          echo "âœ“ MySQL initialized for Joomla"

      pre_stop:
        inline: |
          #!/bin/bash
          BACKUP_DIR="${SHARED_DIR}/data/backups/${CONTAINER_NAME#playground-}"
          mkdir -p "${BACKUP_DIR}"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # Create database backup
          BACKUP_FILE="${BACKUP_DIR}/joomla_db_${TIMESTAMP}.sql"
          echo "Creating database backup..."
          docker exec "${CONTAINER_NAME}" mysqldump -u root -pjoomla joomla_db > "${BACKUP_FILE}" 2>/dev/null
          if [ $? -eq 0 ] && [ -s "${BACKUP_FILE}" ]; then
            gzip "${BACKUP_FILE}"
            echo "âœ“ Joomla database backup created: ${BACKUP_FILE}.gz"
          else
            echo "âœ— Failed to create database backup"
            rm -f "${BACKUP_FILE}"
          fi

    motd: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘                  MySQL for Joomla                            â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ğŸ” Connection:
         Host: mysql-joomla-stack or localhost
         Port: 3306 (external: 3311)
         User: root / joomla
         Password: joomla
         Database: joomla_db

      ğŸ“Š Quick Commands:
         mysql -u root -pjoomla joomla_db

      ğŸŒ phpMyAdmin: http://localhost:8091
      ğŸŒ Joomla: http://localhost:8082

  web-joomla-stack:
    category: web
    description: "Joomla CMS with Apache, MySQL extensions and automatic file backup/restore"
    image: joomla:php8.2-apache
    keep_alive_cmd: apache2-foreground
    shell: /bin/bash
    ports:
      - "8082:80"
    depend_on:
      - mysql-joomla-stack
    environment:
      JOOMLA_DB_HOST: mysql-joomla-stack
      JOOMLA_DB_NAME: joomla_db
      JOOMLA_DB_USER: joomla
      JOOMLA_DB_PASSWORD: joomla
    scripts:
      post_start:
        inline: |
          #!/bin/bash
          set -e  # Exit immediately if there is an error

          echo "Starting automatic Joomla setup..."

          # Variables
          CONTAINER_MYSQL="playground-mysql-joomla-stack"
          DB_HOST="mysql-joomla-stack"
          DB_NAME="joomla_db"
          DB_USER="joomla"
          DB_PASS="joomla"
          SITE_URL="http://localhost:8082"
          ADMIN_EMAIL="admin@example.com"
          ADMIN_USER="admin"
          ADMIN_PASS="admin123456!"
          SITE_NAME="Joomla Auto Install"

          # Wait for MySQL
          echo -n "Waiting for MySQL..."
          until docker exec "$CONTAINER_MYSQL" mysqladmin ping -u root -pjoomla --silent 2>/dev/null; do
            echo -n "."
            sleep 2
          done
          echo " MySQL ready!"

          sleep 5

          # Install PHP extensions
          echo "Installing PHP extensions..."
          docker exec "${CONTAINER_NAME}" sh -c '
          apt-get update && \
          apt-get install -y libzip-dev libpng-dev libjpeg-dev libfreetype6-dev && \
          docker-php-ext-configure gd --with-freetype --with-jpeg && \
          docker-php-ext-install -j$(nproc) gd zip mysqli pdo_mysql && \
          docker-php-ext-enable gd zip mysqli pdo_mysql
          ' > /dev/null 2>&1

          # Permissions
          docker exec "${CONTAINER_NAME}" sh -c '
            chown -R www-data:www-data /var/www/html && \
            find /var/www/html -type d -exec chmod 755 {} \; && \
            find /var/www/html -type f -exec chmod 644 {} \;
          '

          # === BACKUP RESTORE (optional) ===
          BACKUP_DIR="${SHARED_DIR}/data/backups/${CONTAINER_NAME#playground-}"
          RESTORED_DB=false
          RESTORED_FILES=false

          # Restore DB if backup exists
          if [ -d "$BACKUP_DIR" ] && ls "$BACKUP_DIR"/joomla_db_*.sql.gz 1> /dev/null 2>&1; then
            LATEST_DB=$(ls -t "$BACKUP_DIR"/joomla_db_*.sql.gz | head -1)
            echo "Restoring database from: $LATEST_DB"
            gunzip -c "$LATEST_DB" | docker exec -i "$CONTAINER_MYSQL" mysql -u root -pjoomla "$DB_NAME"
            RESTORED_DB=true
            echo "Database restored"
          fi

          # Restore files if backup exists
          if [ -d "$BACKUP_DIR" ] && ls "$BACKUP_DIR"/joomla_files_*.tar.gz 1> /dev/null 2>&1; then
            LATEST_FILES=$(ls -t "$BACKUP_DIR"/joomla_files_*.tar.gz | head -1)
            echo "Restoring files from: $LATEST_FILES"
            TEMP_DIR="/tmp/joomla_restore_$$"
            mkdir -p "$TEMP_DIR"
            tar -xzf "$LATEST_FILES" -C "$TEMP_DIR"
            docker cp "$TEMP_DIR/." "${CONTAINER_NAME}:/var/www/html/"
            rm -rf "$TEMP_DIR"
            RESTORED_FILES=true
            echo "Files restored"
          fi

          # === AUTOMATIC INSTALLATION (only if NOT restored) ===
          if ! $RESTORED_DB && ! $RESTORED_FILES; then
            echo "No backup found. Starting clean Joomla installation..."

            # Wait for Apache to be ready
            echo -n "Waiting for Apache"
            until docker exec "${CONTAINER_NAME}" curl -s -o /dev/null "http://localhost" 2>/dev/null; do
              echo -n "."
              sleep 2
            done
            echo " Apache ready!"

            # Check if installation directory exists
            if docker exec "${CONTAINER_NAME}" test -d /var/www/html/installation; then
              echo "Found Joomla installation directory. Proceeding with CLI installation..."

              # Execute CLI installation (Joomla 4+ supports CLI) with non-interactive stdin
              echo "" | docker exec -i "${CONTAINER_NAME}" php /var/www/html/installation/joomla.php install \
                --site-name="$SITE_NAME" \
                --admin-user="$ADMIN_USER" \
                --admin-username="$ADMIN_USER" \
                --admin-email="$ADMIN_EMAIL" \
                --admin-password="$ADMIN_PASS" \
                --db-host="$DB_HOST" \
                --db-user="$DB_USER" \
                --db-pass="$DB_PASS" \
                --db-name="$DB_NAME" \
                --db-type=mysqli \
                --db-prefix=jos_ \
                --public-folder= 2>&1 || {
                  echo "CLI installation failed, creating configuration manually..."
                }

              # Remove installation folder
              docker exec "${CONTAINER_NAME}" rm -rf /var/www/html/installation
              echo "Joomla installation completed!"
            else
              echo "Installation directory not found, configuration may already exist"
            fi
          fi

          # === CREATE OR UPDATE CONFIGURATION.PHP (if needed) ===
          if ! docker exec "${CONTAINER_NAME}" test -f /var/www/html/configuration.php || ! $RESTORED_FILES; then
            echo "Creating Joomla configuration file..."

            # Generate secret key
            SECRET_KEY=$(openssl rand -hex 16)

            # Create configuration.php with proper variable substitution
            docker exec "${CONTAINER_NAME}" sh -c "cat > /var/www/html/configuration.php << EOF
            <?php
            class JConfig {
                public \\\$host = '${DB_HOST}';
                public \\\$user = '${DB_USER}';
                public \\\$password = '${DB_PASS}';
                public \\\$db = '${DB_NAME}';
                public \\\$dbprefix = 'jos_';
                public \\\$dbtype = 'mysqli';
                public \\\$live_site = '';
                public \\\$offline = '0';
                public \\\$offline_message = 'Site under maintenance';
                public \\\$display_offline_message = '1';
                public \\\$offline_image = '';
                public \\\$sitename = '${SITE_NAME}';
                public \\\$editor = 'tinymce';
                public \\\$captcha = '0';
                public \\\$list_limit = '20';
                public \\\$access = '1';
                public \\\$debug = '0';
                public \\\$debug_lang = '0';
                public \\\$debug_lang_const = '0';
                public \\\$dbsslverifyservercert = '0';
                public \\\$dbsslkey = '';
                public \\\$dbsslcert = '';
                public \\\$dbsslca = '';
                public \\\$dbsslcipher = '';
                public \\\$dbencryption = '0';
                public \\\$error_reporting = 'default';
                public \\\$log_path = '/var/www/html/administrator/logs';
                public \\\$tmp_path = '/var/www/html/tmp';
                public \\\$mailfrom = '${ADMIN_EMAIL}';
                public \\\$fromname = '${SITE_NAME}';
                public \\\$sendmail = '/usr/sbin/sendmail';
                public \\\$smtpauth = '0';
                public \\\$smtpuser = '';
                public \\\$smtppass = '';
                public \\\$smtphost = 'localhost';
                public \\\$smtpsecure = 'none';
                public \\\$smtpport = '25';
                public \\\$caching = '0';
                public \\\$cache_handler = 'file';
                public \\\$cachetime = '15';
                public \\\$cache_platformprefix = '0';
                public \\\$MetaDesc = '';
                public \\\$MetaKeys = '';
                public \\\$MetaTitle = '1';
                public \\\$MetaAuthor = '1';
                public \\\$MetaVersion = '0';
                public \\\$robots = '';
                public \\\$sef = '1';
                public \\\$sef_rewrite = '1';
                public \\\$sef_suffix = '0';
                public \\\$unicodeslugs = '0';
                public \\\$feed_limit = '10';
                public \\\$feed_email = 'none';
                public \\\$secret = '${SECRET_KEY}';
                public \\\$gzip = '0';
                public \\\$force_ssl = '0';
                public \\\$lifetime = '15';
                public \\\$session_handler = 'database';
                public \\\$shared_session = '0';
                public \\\$session_metadata = '1';
            }
          EOF
          "

            # Set proper permissions
            docker exec "${CONTAINER_NAME}" chown www-data:www-data /var/www/html/configuration.php
            docker exec "${CONTAINER_NAME}" chmod 644 /var/www/html/configuration.php
            echo "Configuration file created successfully!"
          else
            echo "Configuration file already exists, skipping creation"
          fi

          # === FINAL OPTIMIZATIONS ===
          # Hide PHP warnings
          docker exec "${CONTAINER_NAME}" sh -c '
            echo "display_errors = Off" >> /usr/local/etc/php/conf.d/joomla.ini
            echo "error_reporting = E_ALL & ~E_WARNING & ~E_NOTICE & ~E_DEPRECATED" >> /usr/local/etc/php/conf.d/joomla.ini
            echo "opcache.enable=1" >> /usr/local/etc/php/conf.d/joomla.ini
            echo "opcache.memory_consumption=128" >> /usr/local/etc/php/conf.d/joomla.ini
            echo "opcache.interned_strings_buffer=8" >> /usr/local/etc/php/conf.d/joomla.ini
            echo "opcache.max_accelerated_files=10000" >> /usr/local/etc/php/conf.d/joomla.ini
            echo "opcache.revalidate_freq=1" >> /usr/local/etc/php/conf.d/joomla.ini
            echo "opcache.save_comments=1" >> /usr/local/etc/php/conf.d/joomla.ini
          '

          # Restart Apache
          docker restart "${CONTAINER_NAME}" > /dev/null 2>&1 || true
          docker exec "${CONTAINER_NAME}" rm -rf /var/www/html/installation

          # === FINAL MESSAGE ===
          echo "Joomla is READY!"
          echo "URL: $SITE_URL"
          if ! $RESTORED_DB && ! $RESTORED_FILES; then
            echo "Admin: $SITE_URL/administrator"
            echo "User: $ADMIN_USER"
            echo "Password: $ADMIN_PASS"
          else
            echo "Restore completed. Use existing credentials."
          fi
          echo "Database: $DB_NAME"

      pre_stop:
        inline: |
          #!/bin/bash
          BACKUP_DIR="${SHARED_DIR}/data/backups/${CONTAINER_NAME#playground-}"
          mkdir -p "${BACKUP_DIR}"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # Create Joomla files backup using docker cp
          echo "Creating Joomla files backup..."

          # Create temporary directory for backup
          TEMP_BACKUP_DIR="${SHARED_DIR}/temp_joomla_backup_${TIMESTAMP}"
          mkdir -p "${TEMP_BACKUP_DIR}"

          # Copy Joomla files from container to temporary directory using docker cp
          docker cp "${CONTAINER_NAME}:/var/www/html/." "${TEMP_BACKUP_DIR}/" 2>/dev/null

          if [ $? -eq 0 ] && [ "$(ls -A "${TEMP_BACKUP_DIR}" 2>/dev/null)" ]; then
            # Create tar archive of the backup CONTENT (not the directory itself)
            FILES_BACKUP="${BACKUP_DIR}/joomla_files_${TIMESTAMP}.tar.gz"
            cd "${TEMP_BACKUP_DIR}"
            tar -czf "${FILES_BACKUP}" . 2>/dev/null

            if [ $? -eq 0 ] && [ -s "${FILES_BACKUP}" ]; then
              echo "âœ“ Joomla files backup created: ${FILES_BACKUP}"
              echo "Backup size: $(du -h "${FILES_BACKUP}" | cut -f1)"
              echo "Backup contents:"
              tar -tzf "${FILES_BACKUP}" | head -10
            else
              echo "âœ— Failed to create files backup archive"
            fi
          else
            echo "âœ— Failed to copy Joomla files from container"
          fi

          # Clean up temporary directory
          rm -rf "${TEMP_BACKUP_DIR}"

          # List all backups for verification
          echo "Current backups in ${BACKUP_DIR}:"
          ls -la "${BACKUP_DIR}"/*.gz 2>/dev/null || echo "No backup files found"

    motd: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘                      Joomla CMS Stack                        â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ğŸŒ Joomla: http://localhost:8082
      ğŸ”§ Admin Panel: http://localhost:8082/administrator
      ğŸ“Š Database: mysql-joomla-stack:3306 (joomla_db)

      admin # ğŸ”‘ Joomla Admin User
      admin123456! # ğŸ”‘ Joomla Admin Password

      ğŸ”§ Features:
         â€¢ Joomla latest with PHP 8.2
         â€¢ Apache with required extensions
         â€¢ MySQL 8 database with UTF8MB4
         â€¢ GD library for images
         â€¢ Zip support for extensions
         â€¢ XML support for feeds
         â€¢ Automatic file and database backup/restore

      ğŸ’¡ First time setup:
         1. Visit http://localhost:8082
         2. Complete Joomla installation wizard:
            - Database Type: MySQLi
            - Database Host: mysql-joomla-stack
            - Database Name: joomla_db
            - Database Username: joomla
            - Database Password: joomla
         3. Create admin account
         4. Remove installation folder (Joomla will prompt)

      ğŸ“š Default Credentials (after installation):
         Database: joomla / joomla
         Admin: (set during installation)

  phpmyadmin-joomla-stack:
    category: database
    description: phpMyAdmin - MySQL Web Interface for Joomla
    image: phpmyadmin:latest
    keep_alive_cmd: /docker-entrypoint.sh apache2-foreground
    shell: /bin/bash
    ports:
      - "8091:80"
    depend_on:
      - mysql-joomla-stack
    environment:
      PMA_HOST: mysql-joomla-stack
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: joomla
      MYSQL_ROOT_PASSWORD: joomla
    scripts:
      post_start:
        inline: |
          #!/bin/bash
          echo "Configuring phpMyAdmin for Joomla..."

          # Wait for MySQL to be ready
          MAX_WAIT=60
          COUNT=0
          echo -n "Waiting for MySQL"
          while [ $COUNT -lt $MAX_WAIT ]; do
            if docker exec "playground-mysql-joomla-stack" mysqladmin ping -u root -pjoomla --silent 2>/dev/null; then
              echo ""
              echo "âœ“ MySQL ready for phpMyAdmin"
              break
            fi
            echo -n "."
            sleep 2
            COUNT=$((COUNT + 2))
          done

          sleep 3

          docker exec "${CONTAINER_NAME}" sh -c '
          cat > /etc/phpmyadmin/config.user.inc.php << "EOF"
          <?php
          $cfg["Servers"][$i]["auth_type"] = "config";
          $cfg["Servers"][$i]["user"] = "root";
          $cfg["Servers"][$i]["password"] = "joomla";
          $cfg["AllowNoPassword"] = true;
          $cfg["LoginCookieValidity"] = 86400;
          $cfg["Servers"][$i]["only_db"] = "joomla_db";
          ?>
          EOF
          ' 2>/dev/null

          echo "âœ“ phpMyAdmin ready at http://localhost:8091"
          echo "âœ“ Auto-login enabled (root/joomla)"

    motd: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘               phpMyAdmin for Joomla                          â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ğŸŒ Access: http://localhost:8091
      ğŸ” Auto-login: Enabled (root/joomla)
      ğŸ“ Default DB: joomla_db

      ğŸ’¡ Manage Joomla database tables:
         â€¢ #__* tables contain Joomla data
         â€¢ #__users: User accounts
         â€¢ #__content: Articles
         â€¢ #__extensions: Components, modules, plugins
         â€¢ #__menu: Menu items
         â€¢ #__categories: Content categories

      ğŸ”§ Common Tasks:
         â€¢ Backup database before major changes
         â€¢ Reset admin password if needed
         â€¢ Clean session tables for performance
         â€¢ Optimize tables regularly
