<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê≥ Docker Playground Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Header -->
    <header>
        <div class="container">
            <h1>üê≥ Docker Playground</h1>
            <p class="subtitle">Manage your containerized development environments</p>
        </div>
    </header>

    <!-- Search Bar -->
    <div class="container">
        <div class="search-bar">
            <input type="text" id="filter" placeholder="üîç Search containers by name or category..." autocomplete="off">
            <span class="search-count" id="search-count"></span>
        </div>
    </div>

    <!-- Container Grid -->
    <div class="container">
        <div id="images" class="image-grid">
            {% for name, data in images.items() %}
            <div class="image-card" data-name="{{ name }}" data-category="{{ data.category }}" data-container="playground-{{ name }}">
                <div class="card-header">
                    <h3>{{ name }}</h3>
                    <span class="badge badge-{{ data.category }}">{{ data.category }}</span>
                </div>
                <p class="card-description">{{ data.description }}</p>
                
                <div class="card-status">
                    {% if running.get(name) %}
                        <span class="status-indicator status-running">‚óè</span>
                        <span class="status-text">Running</span>
                    {% else %}
                        <span class="status-indicator status-stopped">‚óè</span>
                        <span class="status-text">Stopped</span>
                    {% endif %}
                </div>

                <div class="card-actions">
                    {% if running.get(name) %}
                        <button class="btn btn-danger" onclick="stopContainer('{{ name }}', '{{ running[name].name }}')">
                            <span class="btn-icon">‚èπ</span> Stop
                        </button>
                        <button class="btn btn-primary" onclick="showLogs('{{ running[name].name }}')">
                            <span class="btn-icon">üìã</span> Logs
                        </button>
                        <button class="btn btn-success" onclick="openConsole('{{ running[name].name }}', '{{ name }}')">
                            <span class="btn-icon">üíª</span> Console
                        </button>
                    {% else %}
                        <button class="btn btn-success btn-block" onclick="startContainer('{{ name }}')">
                            <span class="btn-icon">‚ñ∂</span> Start Container
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Modal for Logs -->
    <div id="logModal" class="modal">
        <div class="modal-overlay" onclick="closeModal('logModal')"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Container Logs</h2>
                <button class="modal-close" onclick="closeModal('logModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="log-info">
                    Container: <strong id="logContainerName"></strong>
                </div>
                <pre id="logContent" class="log-content"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('logModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for Console -->
    <div id="consoleModal" class="modal">
        <div class="modal-overlay" onclick="closeConsole()"></div>
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>üíª Interactive Console</h2>
                <button class="modal-close" onclick="closeConsole()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="console-info">
                    Container: <strong id="consoleContainerName"></strong>
                    <span class="console-status" id="consoleStatus">‚óè Connected</span>
                </div>
                <div id="terminal" class="terminal-wrapper"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeConsole()">Disconnect</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-webgl@0.16.0/lib/xterm-addon-webgl.js"></script>
    <script>
        let ws = null;
        let term = null;
        let fitAddon = null;

        // Toast Notification System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '‚úì',
                error: '‚úó',
                info: '‚Ñπ',
                warning: '‚ö†'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.add('toast-show'), 10);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Filter/Search
        const filterInput = document.getElementById('filter');
        const searchCount = document.getElementById('search-count');
        const imageCards = document.querySelectorAll('.image-card');

        function updateSearchCount() {
            const visible = Array.from(imageCards).filter(card => card.style.display !== 'none').length;
            searchCount.textContent = `${visible} of ${imageCards.length} containers`;
        }

        function filterImages() {
            const filter = filterInput.value.toLowerCase();
            imageCards.forEach(card => {
                const name = card.getAttribute('data-name').toLowerCase();
                const category = card.getAttribute('data-category').toLowerCase();
                const match = name.includes(filter) || category.includes(filter);
                card.style.display = match ? '' : 'none';
            });
            updateSearchCount();
        }

        filterInput.addEventListener('input', filterImages);
        updateSearchCount();

        // Update card UI after state change
        function updateCardUI(imageName, isRunning, containerName) {
            const card = document.querySelector(`[data-name="${imageName}"]`);
            if (!card) return;

            const statusIndicator = card.querySelector('.status-indicator');
            const statusText = card.querySelector('.status-text');
            const actions = card.querySelector('.card-actions');

            if (isRunning) {
                statusIndicator.className = 'status-indicator status-running';
                statusText.textContent = 'Running';
                actions.innerHTML = `
                    <button class="btn btn-danger" onclick="stopContainer('${imageName}', '${containerName}')">
                        <span class="btn-icon">‚èπ</span> Stop
                    </button>
                    <button class="btn btn-primary" onclick="showLogs('${containerName}')">
                        <span class="btn-icon">üìã</span> Logs
                    </button>
                    <button class="btn btn-success" onclick="openConsole('${containerName}', '${imageName}')">
                        <span class="btn-icon">üíª</span> Console
                    </button>
                `;
            } else {
                statusIndicator.className = 'status-indicator status-stopped';
                statusText.textContent = 'Stopped';
                actions.innerHTML = `
                    <button class="btn btn-success btn-block" onclick="startContainer('${imageName}')">
                        <span class="btn-icon">‚ñ∂</span> Start Container
                    </button>
                `;
            }
        }

        // Start Container (AJAX)
        async function startContainer(image) {
            const card = document.querySelector(`[data-name="${image}"]`);
            const btn = card.querySelector('.btn-success');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Starting...';

            try {
                const response = await fetch(`/start/${image}`, { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    showToast(`Container ${data.container} started successfully`, 'success');
                    updateCardUI(image, true, data.container);
                } else {
                    showToast(`Failed to start ${image}`, 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<span class="btn-icon">‚ñ∂</span> Start Container';
                }
            } catch (e) {
                showToast(`Error: ${e.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '<span class="btn-icon">‚ñ∂</span> Start Container';
            }
        }

        // Stop Container (AJAX)
        async function stopContainer(imageName, containerName) {
            const card = document.querySelector(`[data-name="${imageName}"]`);
            const btn = card.querySelector('.btn-danger');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Stopping...';

            try {
                const response = await fetch(`/stop/${containerName}`, { method: 'POST' });
                
                if (response.ok) {
                    showToast(`Container ${containerName} stopped`, 'success');
                    updateCardUI(imageName, false, '');
                } else {
                    showToast(`Failed to stop ${containerName}`, 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<span class="btn-icon">‚èπ</span> Stop';
                }
            } catch (e) {
                showToast(`Error: ${e.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '<span class="btn-icon">‚èπ</span> Stop';
            }
        }

        // Show Logs
        async function showLogs(container) {
            try {
                const response = await fetch(`/logs/${container}`);
                const data = await response.json();
                
                document.getElementById('logContainerName').textContent = container;
                document.getElementById('logContent').textContent = data.logs || 'No logs available';
                openModal('logModal');
            } catch (e) {
                showToast(`Error loading logs: ${e.message}`, 'error');
            }
        }

        // Modal Management
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('modal-open');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('modal-open');
            document.body.style.overflow = '';
        }

        // Console Management
        function openConsole(container, imageName) {
            document.getElementById('consoleContainerName').textContent = container;
            document.getElementById('consoleStatus').textContent = '‚óè Connecting...';
            openModal('consoleModal');

            // Cleanup previous terminal
            if (term) {
                term.dispose();
                term = null;
            }

            // Create new terminal
            term = new Terminal({
                cursorBlink: true,
                theme: {
                    background: '#1e1e1e',
                    foreground: '#d4d4d4',
                    cursor: '#ffffff',
                    selection: '#264f78'
                },
                fontSize: 14,
                fontFamily: '"Cascadia Code", "Fira Code", "Consolas", "Monaco", monospace',
                scrollback: 10000,
                allowTransparency: true
            });

            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);

            try {
                const webglAddon = new WebglAddon.WebglAddon();
                term.loadAddon(webglAddon);
            } catch (e) {
                console.warn('WebGL addon not available, using canvas renderer');
            }

            term.open(document.getElementById('terminal'));
            fitAddon.fit();

            // Resize on window resize
            window.addEventListener('resize', () => {
                if (fitAddon) fitAddon.fit();
            });

            // Connect WebSocket
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/console/${container}`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('consoleStatus').textContent = '‚óè Connected';
                document.getElementById('consoleStatus').className = 'console-status console-connected';
                term.write('\r\n\x1b[32m‚úì Connected to console\x1b[0m\r\n\r\n');
            };

            ws.onmessage = (event) => {
                term.write(event.data);
                // Auto-scroll to bottom
                term.scrollToBottom();
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('consoleStatus').textContent = '‚óè Error';
                document.getElementById('consoleStatus').className = 'console-status console-error';
                term.write('\r\n\x1b[31m‚úó Connection error\x1b[0m\r\n');
            };

            ws.onclose = () => {
                console.log('WebSocket closed');
                document.getElementById('consoleStatus').textContent = '‚óè Disconnected';
                document.getElementById('consoleStatus').className = 'console-status console-disconnected';
                term.write('\r\n\x1b[33m‚ö† Console disconnected\x1b[0m\r\n');
            };

            term.onData(data => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(data);
                }
            });
        }

        function closeConsole() {
            // Close WebSocket
            if (ws) {
                ws.close();
                ws = null;
            }

            // Dispose terminal
            if (term) {
                term.dispose();
                term = null;
            }

            fitAddon = null;

            // Close modal
            closeModal('consoleModal');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // ESC to close modals
            if (e.key === 'Escape') {
                if (document.getElementById('consoleModal').classList.contains('modal-open')) {
                    closeConsole();
                } else if (document.getElementById('logModal').classList.contains('modal-open')) {
                    closeModal('logModal');
                }
            }
            // Ctrl+K to focus search
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                filterInput.focus();
            }
        });
    </script>
</body>
</html>